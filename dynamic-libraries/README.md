# Динамические библиотеки

Заметки:
  - Динамические библиотеки нужны для экономии памяти - статические библиотеки загружаются в память для каждого приложения отдельно, динамические же загружены в одном экземпляре и используются несколькими приложениями
  - В Linux два метода работы с динамическими библиотеками - динамическая компоновка и динамическая загрузка  
    - Динамическая компоновка - при запуске приложения Linux ищет скомпонованную с приложением библиотеку в памяти и, если её нет, загружает
    - Динамическая загрузка - в коде приложения есть явный вызов загрузки библиотеки и поиск библиотеки в памяти осуществляется после вызова
  
  - Для компиляции динамической библиотеки у gcc есть флаг ```-shared```
  - Для компоновки библиотеки существуют флаги ```-L<путь к библиотеке> -l<имя библиотеки без префикса lib и расширения .so>```
  - Линковщик ld ищет динамические библиотеки в /lib и /usr/lib. Для привязки новой папки существуют два варианта:
    - Переменная окружения **LD_LIBRARY_PATH** - ```export LD_LIBRARY_PATH=<путь к библиотеке```
    - Дополнительные аргументы для gcc ```-Wl,-rpath,<путь к библиотеке>```
  - Для динамической загрузки:
    - Флаг ```-ldl``` для gcc при компиляции
    - ```void *handle = dlopen(<путь к библиотеке>, <флаги>)``` для загрузки библиотеки
        - флаги: **RTLD_NOW** - загрузка сейчас, **RTLD_LAZY** - загрузка при обращении, **RTLD_LOCAL** - нельзя переиспользовать библиотеку в загружаемых далее библиотеках, **RTLD_GLOBAL** - можно переиспользовать в загружаемых далее библиотеках
    - ```dlsym(handle, <имя функции>)``` - возвращает адрес загруженной функции
    - ```dlclose(handle)``` - закрытие библиотеки (если никто её больше не использует, она выгружается из памяти)
    - В C++ для динамичеких библиотек идёт мэнглинг имен функций - в имена функций "зашиваются" параметры
    - Для просмотра исходного имени функции есть утилита ***c++flit*** *<функция с мэнглингом>*
    - Для отключения мэнглинга для функции испольуется ```extern "C"```
    - ***ldd*** *<путь к приложению>* - просмотр динамически компонующихся библиотек для приложения 
    - ***nm*** *<путь к библиотеке/приложению>* - печать таблицы имён библиотеки/приложения
   - Флаг ```-fPIC``` при компиляции библиотеки делает её код позиционно-независимым - без него библиотека должна быть загружена в определённое место в памяти (оно может быть уже занято), с ним место её загрузки не важно